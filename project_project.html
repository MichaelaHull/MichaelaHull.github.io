<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-quiv="X-UA-Compatible" content="IE-edge">
  <meta name="viewpoint" content="width=device-width, initial-scale=1">

  <title>Final Project</title>
  
  <link rel="stylesheet" href="http://s3.amazonaws.com/codecademy-content/courses/ltp/css/bootstrap.css">
  <link rel="stylesheet" href="stylesheets/main.css">
  <link href="bootstrap-3.3.4-dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://s3.amazonaws.com/codecademy-content/courses/ltp/css/shift.css" rel="stylesheet">
  <script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <script src="javascripts/jquery.tipsy.js" type="text/javascript" charset="utf-8"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="sf_map.js"></script>
  <style type="text/css">
  .brush .extent {
    stroke: #fff;
    fill-opacity: .125;
    shape-rendering: crispEdges;
  }

  .line {
    clip-path: url(#clip);
  }

  .d3-tip {
    padding: 12px;
    background: #99BEE3;
    font-family: sans-serif;
    font-size: 12px;
  }
  #chart {
      position: absolute;
      top: 50px;
      left: 100px;
    } 

  </style>
</head>
<body align="center">

<!--NAVIGATIONBAR-->
  <div class="nav">
    <div class="container">
      <div class="row">
        <div class="col-md-0">
        <ul class="pull-left">
          <li><a href="http://MichaelaHull.github.io#homework">Homework</a></li>
          <li><a href="http://MichaelaHull.github.io#projects">Project</a></li>
          <li><a href="http://MichaelaHull.github.io#participation">Participation</a></li>
        </ul>
        </div>
        <div class="col-md-0">
        <ul class="pull-right">
          <li><a href="http://MichaelaHull.github.io#about">About</a></li>
          <li><a href="http://MichaelaHull.github.io#contact">Contact</a></li>
          <li><a href="http://MichaelaHull.github.io">Home</a></li>
        </ul>
        </div>
      </div>
    </div>
  </div>

<!--BANNER-->
  <div class="banner">
    <div class="container">
      <h1>Michaela Hull, Final Project: <strong>SFPD Incidents in October 2014</strong></h1>
      <ul class="pull-right">
        <li><a href="https://data.sfgov.org/Public-Safety/SFPD-Incidents-from-1-January-2003/tmnf-yvry">Source Data</a></li>
        <li><a href="https://github.com/MichaelaHull/MichaelaHull.github.io/blob/master/project_project.html">Code</a></li>
        <li><a href="https://github.com/MichaelaHull/MichaelaHull.github.io/blob/master/data_files/sfpd_incidents_2014.csv">Data</a></li>
        <li><a href="#discussion">Discussion</a></li>
      </ul>
    </div>
  </div>
<div class="section">
<div class="container">
<p id="log" font-size="12px"></p>
<div id="filter"><b>Neighborhoods: </b></div>
<script type="text/javascript">

// The wrapping function is Bostock's with a few small alterations and can be found here: http://bl.ocks.org/mbostock/7555321 

// A special thanks to Monica Meyer for her help in getting my maps working and for allowing me to use her topoJSON file. A lot of my map code is inspired by hers (though not copied!!!) with her permission. Her repo with the map code and original topoJSON file can be found here: https://github.com/monicameyer/MSAN622_repo_meyer

// A lot of the filtering was largely based on the following example: http://plnkr.co/edit/5g4lUXnJa3pmWEfFq8rq?p=preview

  function wrap(text, width) {
    text.each(function() {
      var text = d3.select(this),
          words = text.text().split(/\s+/).reverse(),
          word,
          line = [],
          lineNumber = 0,
          lineHeight = 1.1, // ems
          y = text.attr("y"),
          dy = 12, //parseFloat(text.attr("dy")),
          tspan = text.text(null).append("tspan").attr("x", width / 2).attr("y", y).attr("dy", dy + "em");
      while (word = words.pop()) {
        line.push(word);
        tspan.text(line.join(" "));
        if (tspan.node().getComputedTextLength() > width) {
          line.pop();
          tspan.text(line.join(" "));
          line = [word];
          tspan = text.append("tspan").attr("x", width / 2).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
        }
      }
    });
  }

  var baseURL = "https://gist.githubusercontent.com/mbostock/4090846/raw/"

  var svg_ts_height = 400;
  var svg_ts_width = 900;
  var margin = 30;
  var lab_margin = 80;
  var svg_crime_height = 280;
  var svg_crime_width = svg_ts_width/2;
  var svg_hood_height = svg_crime_height;
  var svg_hood_width = svg_crime_width;
  var svg_brush_height = 100;
  var svg_brush_width = svg_ts_width;
  var svg_smallmap_width = 120;
  var svg_smallmap_height = 100;
  var svg_map_height = 500;
  var svg_map_width = 650;
  var svg_mapfilter_height = svg_map_height;
  var svg_mapfilter_width = svg_ts_width - svg_map_width;
  var svg_smallmult_height = svg_map_height;
  var svg_smallmult_width = 245;
  var svg_res_height = 350;
  var svg_res_width = svg_ts_width;
  // var svg_time_height = 500;
  // var svg_time_width = svg_time_height;
  // var svg_day_height = svg_time_height;
  // var svg_day_width = svg_day_height;

  var plot_ts_height = svg_ts_height - 2*margin;
  var plot_ts_width = svg_ts_width - margin - lab_margin;
  var plot_crime_height = svg_crime_height - 3*margin;
  var plot_crime_width = svg_crime_width - 2*lab_margin - margin;
  var plot_hood_height = svg_hood_height - 3*margin;
  var plot_hood_width = svg_hood_width - lab_margin - margin;
  var plot_brush_height = svg_brush_height - 2*margin;
  var plot_brush_width = plot_ts_width;
  var plot_res_height = svg_res_height - 2*margin;
  var plot_res_width = svg_res_width - 2*lab_margin - 2*margin;
  // var plot_time_height = svg_time_height - 2*margin;
  // var plot_time_width = svg_time_width - 2*margin;
  // var plot_day_width = svg_day_width - 2*margin;
  // var plot_day_height = svg_day_height - 2*margin;

  var duration = 300;

  var svg_map = d3.select("body").append("svg")
    .attr("height", svg_map_height)
    .attr("width", svg_map_width);

  var svg_smallmult = d3.select("body").append("svg")
    .attr("height", svg_smallmult_height)
    .attr("width", svg_smallmult_width);

  var map_theft = svg_smallmult.append("g")
    .attr("transform", "translate(" + (0 * (svg_smallmap_width + 15)) + "," + (0 * (svg_smallmap_height + 25)) + ")");

  var map_other = svg_smallmult.append("g")
    .attr("transform", "translate(" + (1 * (svg_smallmap_width + 15)) + "," + (0 * (svg_smallmap_height + 25)) + ")");

  var map_vandalism = svg_smallmult.append("g")
    .attr("transform", "translate(" + (0 * (svg_smallmap_width + 15)) + "," + (1 * (svg_smallmap_height + 25)) + ")");

  var map_assault = svg_smallmult.append("g")
    .attr("transform", "translate(" + (1 * (svg_smallmap_width + 15)) + "," + (1 * (svg_smallmap_height + 25)) + ")");

  var map_controlled = svg_smallmult.append("g")
    .attr("transform", "translate(" + (0 * (svg_smallmap_width + 15)) + "," + (2 * (svg_smallmap_height + 25)) + ")");

  var map_kidnapping = svg_smallmult.append("g")
    .attr("transform", "translate(" + (1 * (svg_smallmap_width + 15)) + "," + (2 * (svg_smallmap_height + 25)) + ")");

  var map_all = svg_smallmult.append("g")
    .attr("transform", "translate(" + (0 * (svg_smallmap_width + 15)) + "," + (3 * (svg_smallmap_height + 25)) + ")");

  var tip = d3.tip()
    .attr("class", "d3-tip")
    .offset([-10, 0])
    .html(function (d, i) { return crime_name_dict[d.gen_cat] + " in " + d.PdDistrict + " on</br>" + d.DayOfWeek + ", " + d.Date.substring(3, 5) + " October, 2014, at " + d.Time.substring(0, 5) + "</br>Category: " + d.Category + "</br>Description: " + d.Descript + "</br>Resolution: " + d.Resolution; });
  svg_map.call(tip);

  var svg_res = d3.select("body").append("svg")
    .attr("height", svg_res_height)
    .attr("width", svg_res_width);

  var plot_res = svg_res.append("g")
    .attr("transform", "translate(" + (2*lab_margin + margin) + "," + margin + ")");

  var svg_crime = d3.select("body").append("svg")
    .attr("height", svg_crime_height)
    .attr("width", svg_crime_width);

  var plot_crime = svg_crime.append("g")
    .attr("transform", "translate(" + 2*lab_margin + "," + 2*margin + ")");

  var svg_hood = d3.select("body").append("svg")
    .attr("height", svg_hood_height)
    .attr("width", svg_hood_width);

  var plot_hood = svg_hood.append("g")
    .attr("transform", "translate(" + lab_margin + "," + 2*margin + ")");

  var svg_ts = d3.select("body").append("svg")
    .attr("height", svg_ts_height)
    .attr("width", svg_ts_width);
  svg_ts.append("defs").append("clipPath")
    .attr("id", "clip")
    .append("rect")
    .attr("width", plot_ts_width)
    .attr("height", plot_ts_height);

  var plot_ts = svg_ts.append("g")
    .attr("transform", "translate(" + lab_margin + "," + margin + ")");

  var svg_brush = d3.select("body").append("svg")
    .attr("height", svg_brush_height)
    .attr("width", svg_brush_width);

  var plot_brush = svg_brush.append("g")
    .attr("transform", "translate(" + lab_margin + "," + margin + ")");

  // var svg_time = d3.select("body").append("svg")
  //   .attr("height", svg_time_height)
  //   .attr("width", svg_time_width);
  // var plot_time = svg_time.append("g")
  //   .attr("transform", "translate(" + margin + "," + margin + ")");

  // var svg_day = d3.select("body").append("svg")
  //   .attr("height", svg_day_height)
  //   .attr("width", svg_day_width);
  // var plot_day = svg_day.append("g")
  //   .attr("transform", "translate(" + margin + "," + margin + ")");

  var districts = ["Southern", "Northern", "Mission", "Central", "Ingleside", "Bayview", "Tenderloin", "Taraval", "Park", "Richmond"];
  var sorted_districts = ["Bayview", "Central", "Ingleside", "Mission", "Northern", "Park", "Richmond", "Southern", "Taraval", "Tenderloin"]
  var crimes = ["Theft", "Other", "Vandalism", "Assault", "Controlled", "Kidnapping"];
  var crime_names = ["Theft", "Other", "Disorderly Conduct", "Violent Crime", "Controlled Substances/Items", "Kidnapping"];
  var crime_name_dict = {
    "Theft": "Theft",
    "Other": "Other",
    "Vandalism": "Vandalism/disorderly conduct",
    "Assault": "Assault/violent crime",
    "Controlled": "Controlled substances/items",
    "Kidnapping": "Kidnapping/missing persons",
    "All": "All incident types"
  };

  var resolutions = ["None", "Arrest, booked", "Arrest, cited", "Psychopathic case", "Unfounded", "Located", "Juvenile booked", "Exceptional clearance", "Not prosecuted", "Cleared-contact juvenile for more info", "Juvenile admonished", "Juvenile cited", "Juvenile diverted"];

  var crime_dict = [];
  var district_dict = [];
  var res_dict = [];

  function count_start(keys, dict, thing, otherthings) {
    var k;
    for (k in keys) {
      var u = {};
      u[thing] = keys[k];
      u["count"] = 0;
      var t;
      for (t in otherthings){
        u[otherthings[t]] = 0
      };
      dict.push(u);
    };
  };

  count_start(districts, district_dict, "district", crimes);
  count_start(crimes, crime_dict, "gen_cat", districts);
  count_start(resolutions, res_dict, "resolution", crimes.concat(districts));

  var date_format = d3.time.format("%m/%d/%Y");
  var date_time = d3.time.format("%Y-%m-%d %H:%M:%S");
  var date_output = d3.time.format("%A, %B %d");
  var time_output = d3.time.format("%I %p");

  var color = d3.scale.ordinal()
    .domain(crimes)
    .range(["#e6ab02", "#666666", "#1b9e77", "#e7298a", "#7570b3", "#17becf"]);

  var small_maps = [map_theft, map_other, map_vandalism, map_assault, map_controlled, map_kidnapping, map_all];

  var big_projection = d3.geo.mercator()
    .scale(1)
    .translate([0, 0])
    .precision(0);
  var big_path = d3.geo.path()
    .projection(big_projection);

  var small_projection = d3.geo.mercator()
    .scale(1)
    .translate([0, 0])
    .precision(0);
  var small_path = d3.geo.path()
    .projection(small_projection);

  var dropDownNeighbor = d3.select("#filter")
    .append("select")
    .attr("name", "neighbor-list");
  var neighborOptions = dropDownNeighbor.selectAll("option")
    .data(["All"].concat(sorted_districts))
    .enter()
    .append("option");

  neighborOptions.text(function (d) { return d; })
    .attr("value", function (d) { return d; });

  d3.json("data_files/sf_topojson.json", function (mapError, mapData) {
        var log = d3.select("#log");
        log.style("font-size", "12px")
          .text("Drawing maps... Please wait");
        var featureCollection = topojson.feature(mapData, mapData.objects.collection);
        var bounds = big_path.bounds(featureCollection);
        
        var big_scale = (svg_map_height - 20) / Math.abs(bounds[1][1] - bounds[0][1]);
        var small_scale = (svg_smallmap_height - 5) / Math.abs(bounds[1][1] - bounds[0][1]);
        var big_trans = [(svg_map_width - big_scale * (bounds[1][0] + bounds[0][0]))/2, (svg_map_height - big_scale * (bounds[1][1] + bounds[0][1]))/2];
        var small_trans = [(svg_smallmap_width - small_scale * (bounds[1][0] + bounds[0][0])) / 2, (svg_smallmap_height - small_scale * (bounds[1][1] + bounds[0][1])) / 2];

        big_projection.scale(big_scale).translate(big_trans);
        small_projection.scale(small_scale).translate(small_trans);

        svg_map.append("path")
            .datum(topojson.feature(mapData, mapData.objects.collection))
            .attr("class", "land")
            .attr("d", big_path)
            .attr("fill", "#DAE3E8");
        // svg_map.append("path")
        //     .datum(topojson.mesh(mapData, mapData.objects.collection, function (a, b) { return a !== b; }))
        //     .attr("class", "boundary")
        //     .attr("d", big_path)
        //     .attr("fill", "none")
        //     .attr("stroke", "white");

        var s;
        for (s in small_maps) {
          small_maps[s].append("path")
            .datum(topojson.feature(mapData, mapData.objects.collection))
            .attr("class", "land")
            .attr("d", small_path)
            .attr("fill", "#DAE3E8");
          // small_maps[s].append("path")
          //   .datum(topojson.mesh(mapData, mapData.objects.collection, function (a, b) { return a !== b; }))
          //   .attr("class", "boundary")
          //   .attr("d", small_path)
          //   .attr("fill", "none")
          //   .attr("stroke", "white");
        };
        log.text("Fetching data... Please wait");

      d3.csv("data_files/sfpd_incidents_10_2014.csv", function (dataError, dataData) {
        dataData.forEach(function (d, i) {
          d.IncidntNum = d.IncidntNum;
          d.Category = d.Category;
          d.Descript = d.Descript;
          d.DayOfWeek = d.DayOfWeek;
          d.Date = d.Date;
          d.Time = d.Time;
          d.PdDistrict = d.PdDistrict;
          d.Resolution = d.Resolution;
          d.X = + d.X;
          d.Y = + d.Y;
          d.gen_cat = d.gen_cat;
          d.datetime = date_time.parse(d.datetime);
          var u = crimes.indexOf(d.gen_cat);
          crime_dict[u]["count"] = crime_dict[u]["count"] + 1;
          crime_dict[u][d.PdDistrict] = crime_dict[u][d.PdDistrict] + 1;
          var v = districts.indexOf(d.PdDistrict);
          district_dict[v]["count"] = district_dict[v]["count"] + 1;
          district_dict[v][d.gen_cat] = district_dict[v][d.gen_cat] + 1;
          var q = resolutions.indexOf(d.Resolution);
          if (q > -1) {
          res_dict[q]["count"] = res_dict[q]["count"] + 1;
          res_dict[q][d.gen_cat] = res_dict[q][d.gen_cat] + 1;
          res_dict[q][d.PdDistrict] = res_dict[q][d.PdDistrict] + 1;};
        });
        console.log("Res: ", res_dict);
        var res_bars = plot_res.selectAll("rect")
          .data(res_dict, function (d, i) { return d.resolution; })
          .enter();

        var x_res_scale = d3.scale.linear()
          .domain([0, 9140])
          .range([0, plot_res_width]);
        var y_res_scale = d3.scale.linear()
          .domain([0, resolutions.length])
          .range([0, plot_res_height]);
        var y_res = d3.scale.ordinal()
          .domain(resolutions)
          .rangeRoundBands([0, y_res_scale(resolutions.length)]);

        var xAxis_res = d3.svg.axis()
          .scale(x_res_scale)
          .orient("top");

        var yAxis_res = d3.svg.axis()
          .scale(y_res)
          .orient("left")
          .ticks(0);

        res_bars.append("rect")
          .attr("class", "res_bars")
          .attr("x", 0)
          .attr("y", function (d, i) { return y_res_scale(i + 0.1); })
          .attr("height", y_res_scale(0.8))
          .attr("width", function (d, i) { return x_res_scale(d.count); })
          .attr("fill", "#C16C33");

        plot_res.append("g")
          .attr("class", "x axis")
          .call(xAxis_res);

        plot_res.append("g")
          .attr("class", "y axis")
          .call(yAxis_res);

        var crime_bars = plot_crime.selectAll("rect")
          .data(crime_dict, function (d, i) { return d.gen_cat; })
          .enter();

        var x_crime_scale = d3.scale.linear()
          .domain([0, 5716])
          .range([0, plot_crime_width]);
        var y_crime_scale = d3.scale.linear()
          .domain([0, crimes.length])
          .range([0, plot_crime_height]);
        var y_crime = d3.scale.ordinal()
          .domain(crime_names)
          .rangeRoundBands([0, y_crime_scale(crimes.length)]);

        var xAxis_crime = d3.svg.axis()
          .scale(x_crime_scale)
          .orient("top")
          .ticks(5);
        var yAxis_crime = d3.svg.axis()
          .scale(y_crime)
          .orient("left")
          .ticks(0);

        crime_bars.append("rect")
          .attr("class", "crime_bars")
          .attr("x", 0)
          .attr("y", function (d, i) { return y_crime_scale(i + 0.1); })
          .attr("height", y_crime_scale(0.8))
          .attr("width", function (d, i) { return x_crime_scale(d.count); })
          .attr("fill", function (d, i) { return color(d.gen_cat); });

        plot_crime.append("g")
          .attr("class", "y axis")
          .call(yAxis_crime);
        plot_crime.append("g")
          .attr("class", "x axis")
          .call(xAxis_crime);

        var neighbor_bars = plot_hood.selectAll("rect")
          .data(district_dict, function (d, i) { return d.district; })
          .enter();

        var x_neighbor_scale = d3.scale.linear()
          .domain([0, 2614])
          .range([0, plot_hood_width]);
        var y_neighbor_scale = d3.scale.linear()
          .domain([0, districts.length])
          .range([0, plot_hood_height]);
        var y_neighbor = d3.scale.ordinal()
          .domain(districts)
          .rangeRoundBands([0, y_neighbor_scale(districts.length)]);

        neighbor_bars.append("rect")
          .attr("class", "neighbor_bars")
          .attr("x", 0)
          .attr("y", function (d, i) { return y_neighbor_scale(i + 0.1); })
          .attr("height", y_neighbor_scale(0.8))
          .attr("width", function (d, i) { return x_neighbor_scale(d.count); })
          .attr("fill", "#66a61e");

        var xAxis_neighbor = d3.svg.axis()
          .scale(x_neighbor_scale)
          .orient("top")
          .ticks(6);
        var yAxis_neighbor = d3.svg.axis()
          .scale(y_neighbor)
          .orient("left");

        plot_hood.append("g")
          .attr("class", "x axis")
          .call(xAxis_neighbor);
        plot_hood.append("g")
          .attr("class", "y axis")
          .call(yAxis_neighbor);

        svg_map.append("text")
          .attr("text-anchor", "beginning")
          .attr("transform", "translate(80,40)")
          .style("font-size", "14px")
          .style("font-family", "sans-serif")
          .text("Geographic Locations of SFPD Incidents for October of 2014");

        plot_crime.append("text")
          .attr("text-anchor", "beginning")
          .attr("transform", "translate(0,-25)")
          .style("font-size", "12px")
          .style("font-family", "sans-serif")
          .text("Number of Incidents by Type for October, 2014");

        plot_hood.append("text")
          .attr("text-anchor", "beginning")
          .attr("transform", "translate(0,-25)")
          .style("font-size", "12px")
          .style("font-family", "sans-serif")
          .text("Number of Incidents by Neighborhood for October, 2014");

        plot_res.append("text")
          .attr("text-anchor", "end")
          .attr("transform", "translate(" + plot_res_width + ",40)")
          .style("font-size", "14px")
          .style("font-family", "sans-serif")
          .text("Number of Incidents by Resolution for October, 2014");

        var radius = 2;
        var circles = svg_map.append("g").selectAll("circle")
          .data(dataData)
          .enter();
        circles.append("circle")
          .attr("class", "circles")
          .attr({
            r: radius,
            cx: function (d, i) { return big_projection([d.X, d.Y])[0]; },
            cy: function (d, i) { return big_projection([d.X, d.Y])[1]; },
            id: function (d, i) { return d.IncidntNum; }
          })
          .style("fill", function (d, i) { return color(d.gen_cat); })
          .style("opacity", 0.3)
          .on("mouseover", function (d, i) {
            d3.select(this)
              .transition(duration)
              .style("fill", "#0000FF")
              .style("opacity", 1)
              .attr("r", 4 * radius);
            var mouse = d3.mouse(svg_map.node()).map(function (d, i) { return parseInt(d); });
            tip.show(d, i);
          })
          .on("mouseout", function (d, i) {
            d3.select(this)
              .transition(duration)
              .style("fill", function (d, i) { return color(d.gen_cat); })
              .style("opacity", 0.3)
              .attr("r", radius);
            tip.hide(d, i);
          });
 
        dropDownNeighbor.on("change", function() {
          var selected = this.value;
          displayOthers = this.checked ? "inline" : "none";
          display = this.checked ? "none" : "inline";

          if (selected == 'All') {
            svg_map.selectAll(".circles")
              .transition(duration)
              .style("opacity", 0.3);
            svg_map.selectAll(".circles")
              .attr("display", display);
            plot_crime.selectAll(".crime_bars")
                .transition(2*duration)
                .ease("quad")
                .attr("width", function (d, i) { return x_crime_scale(d.count); });
            plot_hood.selectAll(".neighbor_bars")
                .transition(2*duration)
                .ease("quad")
                .attr("width", function (d, i) { return x_neighbor_scale(d.count); });
            plot_res.selectAll(".res_bars")
                .transition(2*duration)
                .ease("quad")
                .attr("width", function (d, i) { return x_res_scale(d.count); });
          }
          else {
            svg_map.selectAll(".circles")
                .filter(function(d) { return selected !== d.PdDistrict; })
                .transition(duration)
                .attr("display", displayOthers)
                .style("opacity", function (d, i) {
                  if (d.PdDistrict === selected) { return 0.3; }
                  else { return 0; }
                });
                
            svg_map.selectAll(".circles")
                .filter(function(d) { return selected === d.PdDistrict; })
                .transition(duration)
                .attr("display", display)
                .style("opacity", function (d, i) {
                  if (d.PdDistrict === selected) { return 0.3; }
                  else { return 0; }});

            plot_crime.selectAll(".crime_bars")
                .transition(2*duration)
                .ease("quad")
                .attr("width", function (d, i) { return x_crime_scale(+d[selected]); });

            plot_hood.selectAll(".neighbor_bars")
                .transition(2*duration)
                .ease("quad")
                .attr("width", function (d, i) {
                  if (d.district === selected) { return x_neighbor_scale(d.count);
                  }
                  else {return 0; } });

            plot_res.selectAll(".res_bars")
                .transition(2*duration)
                .ease("quad")
                .attr("width", function (d, i) { return x_res_scale(+d[selected]); });
          }
        });
        var b;
        for (b in crimes.concat(["All"])) {
          var points = small_maps[b].selectAll("circle")
            .data(dataData, function (d, i) {
              if (crimes.concat(["All"])[b] === "All") { return d.PdId; }
              else if (d.gen_cat === crimes[b]) { return d.PdId; }
            })
            .enter();
          points.append("circle")
            .attr("r", radius/2)
            .attr("cx", function (d, i) { return small_projection([d.X, d.Y])[0]; })
            .attr("cy", function (d, i) { return small_projection([d.X, d.Y])[1]; })
            .attr("fill", function (d, i) { return color(d.gen_cat); })
            .attr("opacity", 0.2);
          small_maps[b].append("text")
            .attr("x", svg_smallmap_width)
            .attr("y", -10)
            .attr("text-anchor", "middle")
            .attr("font-size", "10px")
            .text(crime_name_dict[crimes.concat(["All"])[b]])
            .call(wrap, svg_smallmap_width);
        };
        var buttons = svg_smallmult.append("g").selectAll("rect")
            .data(crimes.concat(["All"]), function (d, i) { return crimes.concat(["All"])[i]; })
            .enter();
        buttons.append("rect")
            .attr("class", "buttons")
            .attr("id", function (d, i) { return crimes.concat(["All"])[i]; })
            .attr("height", svg_smallmap_height)
            .attr("width", svg_smallmap_width)
            .attr("x", function (d, i) { return (i % 2) * (svg_smallmap_width + 15); })
            .attr("y", function (d, i) { return Math.floor(i / 2) * (svg_smallmap_height + 25); })
            .style("fill", "#99BEE3")
            .attr("opacity", 0)
            .on("mouseover", function (d, i) {
              d3.select(this)
                .transition(duration)
                .attr("opacity", 0.2);
            })
            .on("mouseout", function (d, i) {
              d3.select(this)
                .transition(duration)
                .attr("opacity", 0);
            })
            .on("click", function (d, i) {
              if (d === "All") {
                svg_map.selectAll(".circles")
                  .transition(duration)
                  .style("opacity", 0.3)
                  .attr("display", this.checked ? "none": "inline");
                plot_crime.selectAll(".crime_bars")
                  .transition(2*duration)
                  .ease("quad")
                  .attr("width", function (a, b) { return x_crime_scale(a.count); });
                plot_hood.selectAll(".neighbor_bars")
                  .transition(2*duration)
                  .ease("quad")
                  .attr("width", function (a, b) { return x_neighbor_scale(a.count); });
                plot_res.selectAll(".res_bars")
                  .transition(2*duration)
                  .ease("quad")
                  .attr("width", function (a, b) { return x_res_scale(a.count); });
              }
              else {
                svg_map.selectAll(".circles")
                  .filter(function (a, b) { return a.gen_cat === d; })
                  .transition(duration)
                  .attr("display", this.checked ? "none": "inline")
                  .style("opacity", function (a, b) {
                    if (a.gen_cat === d) { return 0.3; }
                    else { return 0; }
                  });
                svg_map.selectAll(".circles")
                  .filter(function (a, b) { return a.gen_cat != d; })
                  .transition(duration)
                  .attr("display", this.checked ? "inline": "none")
                  .style("opacity", function (a, b) {
                    if (a.gen_cat === d) { return 0.3; }
                    else { return 0; }
                  });
                plot_crime.selectAll(".crime_bars")
                  .transition(2*duration)
                  .ease("quad")
                  .attr("width", function (a, b) {
                    if (a.gen_cat === d) { return x_crime_scale(a.count); }
                    else { return 0; }
                  });
                plot_hood.selectAll(".neighbor_bars")
                  .transition(2*duration)
                  .ease("quad")
                  .attr("width", function (a, b) { return x_neighbor_scale(a[d]); });
                plot_res.selectAll(".res_bars")
                  .transition(2*duration)
                  .ease("quad")
                  .attr("width", function (a, b) { return x_res_scale(a[d]); });
              };
            });
        log.text("Hover over map for more information about a specific incident, or use filters to see a specific neighborhood or incident type");
      });
    });

  var x_ts = d3.time.scale()
    .range([0, plot_ts_width]);

  var x_brush_ts = d3.time.scale()
    .range([0, plot_brush_width]);

  var y_brush_ts = d3.scale.linear()
    .domain([0, 245])
    .range([plot_brush_height, 0]);

  var y_ts = d3.scale.linear()
      .domain([0, 245])
      .range([plot_ts_height, 0]);

  var xAxis_ts = d3.svg.axis()
    .scale(x_ts)
    .orient("bottom");

  var xAxis_brush_ts = d3.svg.axis()
    .scale(x_brush_ts)
    .orient("bottom");

  var yAxis_ts = d3.svg.axis()
    .scale(y_ts)
    .orient("left");

  var yAxis_brush_ts = d3.svg.axis()
    .scale(y_brush_ts)
    .orient("left")
    .ticks(0);

  var brush = d3.svg.brush()
    .x(x_brush_ts)
    .on("brush", brushed);

  var line = d3.svg.line()
    .interpolate("basis")
    .x(function (d, i) { return x_ts(d.Date); })
    .y(function (d, i) { return y_ts(d.rate); })

  var line_brush = d3.svg.line()
    .interpolate("basis")
    .x(function (d, i) { return x_brush_ts(d.Date); })
    .y(function (d, i) { return y_brush_ts(d.rate); })

  d3.csv("data_files/sfpd_incidents_2014_ts_crime.csv", function (error, data) {
    data.forEach(function (d) {
      d.Date = date_format.parse(d.Date);
      d.Theft = + d.Theft;
      d.Other = + d.Other;
      d.Vandalism = + d.Vandalism;
      d.Assault = + d.Assault;
      d.Controlled = + d.Controlled;
      d.Kidnapping = + d.Kidnapping;
    });
    
    var time_domain = d3.extent(data, function (d, i) { return d.Date; });

    x_ts.domain(time_domain);
    x_brush_ts.domain(time_domain);

    var crime = color.domain().map(function (name) {
      return {
        name: name,
        values: data.map(function (d, i) {
          return {Date: d.Date, rate: +d[name]};
        })
      };
    });

    var crime_series = plot_ts.selectAll(".crime_series")
      .data(crime)
      .enter()
      .append("g")
      .attr("class", "crime_series");

    crime_series.append("path")
      .attr("class", "line")
      .attr("d", function (d, i) { return line(d.values); })
      .style("fill", "none")
      .style("stroke-width", "1.5px")
      .style("opacity", 0.8)
      .style("stroke", function (d, i) { return color(d.name); });

    var crime_brush = plot_brush.selectAll(".crime_brush")
      .data(crime)
      .enter()
      .append("g")
      .attr("class", "crime_brush");

    crime_brush.append("path")
      .attr("class", "line")
      .attr("d", function (d, i) { return line_brush(d.values); })
      .style("fill", "none")
      .style("stroke-width", "1.5px")
      .style("opacity", 0.8)
      .style("stroke", function (d, i) { return color(d.name); });

    plot_brush.append("g")
      .attr("class", "x brush")
      .call(brush)
      .selectAll("rect")
      .attr("y", -6)
      .attr("height", plot_brush_height + 7);

    plot_ts.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + plot_ts_height + ")")
      .call(xAxis_ts);

    plot_ts.append("g")
      .attr("class", "y axis")
      .call(yAxis_ts);

    plot_ts.append("text")
      .attr("transform", "translate(-28,0) rotate(-90)")
      .style("text-anchor", "end")
      .style("font-size", "10px")
      .style("font-weight", "bold")
      .text("Number of Incidents");

    plot_ts.append("text")
      .attr("transform", "translate(" + plot_ts_width + ",0)")
      .style("text-anchor", "end")
      .style("font-size", "14px")
      .text("Time Series of SFPD Incidents by Type for 2014");

    plot_brush.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + plot_brush_height + ")")
      .call(xAxis_brush_ts);

    plot_brush.append("g")
      .attr("class", "y axis")
      .call(yAxis_brush_ts);

  });

  function brushed() {
    x_ts.domain(brush.empty() ? x_brush_ts.domain() : brush.extent());
    plot_ts.selectAll(".line").attr("d", function (d, i) { return line(d.values); });
    plot_ts.select(".x.axis").call(xAxis_ts);
  };

//   var days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday", "Eighthday"];
//   var hours = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24"];

//   var x_time_scale = d3.scale.linear()
//     .domain([0, 4692])
//     .range([0, plot_time_height / 2]);
//   var xAxis_time = d3.svg.axis()
//     .scale(x_time_scale)
//     .orient("left");


// var d = [[],[],[],[],[],[]];
// var steps = [1, 2, 3, 4];
// var stepnames = ["one", "two", "three", "four"];
// var gridlines_time = [];
// var s;
// for (s in steps) {
//   gridlines_time.push({name: stepnames[s], step: +steps[s]*1000})
// };

// // Time of day radial plot
//   d3.csv("data_files/sfpd_incidents_2014_time_ts.csv", function (error, data) {
//     data.forEach(function (d) {
//       d.Theft = + d.Theft;
//       d.Other = + d.Other;
//       d.Vandalism = + d.Vandalism;
//       d.Assault = + d.Assault;
//       d.Kidnapping = + d.Kidnapping;
//       d.Controlled = + d.Controlled;
//       d.hour = d.hour;
//       timeData[0].push({axis: d.hour, Theft: d.Theft});
//       timeData[1].push({axis: d.hour, Other: d.Other});
//       timeData[2].push({axis: d.hour, Vandalism: d.Vandalism});
//       timeData[3].push({axis: d.hour, Assault: d.Assault});
//       timeData[4].push({axis: d.hour, Controlled: d.Controlled});
//       timeData[5].push({axis: d.hour, Kidnapping: d.Kidnapping});
//     });


//   //   console.log("Time Data: ", timeData);
//   //   var max_rate = 4692;
//   //   var axes_step = 1000;

//   //   var x_time_scale = d3.scale.linear()
//   //     .domain([0, max_rate])
//   //     .range([0, plot_time_height / 2]);

//   //   var xAxis_time = d3.svg.axis()
//   //     .scale(x_time_scale)
//   //     .orient("left")
//   //     .ticks(6);

//   //   var xAxis_gen = d3.svg.axis()
//   //     .scale(x_time_scale)
//   //     .orient("left")
//   //     .ticks(0);

//   //   plot_time.append("g")
//   //     .attr("class", "x axis")
//   //     .call(xAxis_time)
//   //     .style("fill", "#6D6D82")
//   //     .attr("transform", "translate(" + (plot_time_height / 2) + "," + (plot_time_height / 2) + ")");

//   //   var t;
//   //   for (t in hours) {
//   //     plot_time.append("g")
//   //       .attr("class", "x axis")
//   //       .call(xAxis_gen)
//   //       .attr("transform", "translate(" + (plot_time_height / 2) + "," + (plot_time_height / 2) + ") rotate(" + (360 * t/(hours.length -1)) + ")") 
//   //     }

//   //   var gridlines = d3.svg.line()
//   //     .x(function (d, i) { x_time_scale(d.step)*Math.cos(2*i*Math.PI/(hours.length-1)); })
//   //     .y(function (d, i) { x_time_scale(d.step)*Math.sin(2*i*Math.PI/(hours.length-1)); });

//   //   var time_grid = plot_time.selectAll(".time_grid")
//   //     .data(gridlines_time, function (d, i) { return d.name; })
//   //     .enter()
//   //     .append("g")
//   //     .attr("class", "time_grid");
//   //   time_grid.append("path")
//   //     .attr("class", "line")
//   //     // .attr("d", function (d, i) { return gridlines(d.step); })
//   //     .style("fill", "none")
//   //     .style("opacity", 0.8)
//   //     .style("stroke", "#6D6D82");
//   // console.log("Grid info: ", time_grid, gridlines);
    
//   });

// var daysData = [];

// d3.csv("data_files/sfpd_incidents_2014_day_ts.csv", function (error, data) {
//   data.forEach(function (d) {
//     d.Theft = + d.Theft;
//     d.Other = + d.Other;
//     d.Vandalism = + d.Vandalism;
//     d.Assault = + d.Assault;
//     d.Controlled = + d.Controlled;
//     d.Kidnapping = + d.Kidnapping;
//     d.DayOfWeek = d.DayOfWeek;
//     daysData.push({"DayOfWeek": d.DayOfWeek, "Theft": d.Theft, "Other": d.Other, "Vandalism": d.Vandalism, "Assault": d.Assault, "Controlled": d.Controlled, "Kidnapping": d.Kidnapping});
//   });
//     console.log("Day Data: ", daysData);
//     var max_rate = 9294;
//     var axes_step = 2000;

//     var x_day_scale = d3.scale.linear()
//       .domain([0, max_rate])
//       .range([0, plot_day_height / 2]);

//     var xAxis_day = d3.svg.axis()
//       .scale(x_day_scale)
//       .orient("left")
//       .ticks(6);

//     var xAxis_gen = d3.svg.axis()
//       .scale(x_day_scale)
//       .orient("left")
//       .ticks(0);

//     plot_day.append("g")
//       .attr("class", "x axis")
//       .call(xAxis_day)
//       .style("fill", "#6D6D82")
//       .attr("transform", "translate(" + (plot_day_height / 2) + "," + (plot_day_height / 2) + ")");

//     var t;
//     for (t in days) {
//       plot_day.append("g")
//         .attr("class", "x axis")
//         .call(xAxis_gen)
//         .attr("transform", "translate(" + (plot_day_height / 2) + "," + (plot_day_height / 2) + ") rotate(" + (360 * t/(days.length -1)) + ")") 
//       }
// })
  
</script>
</div>  
</div>

<div class="section">
    <div class="container">
      <h2 align="left">How the data is sorted</h2>
      <p align="left">For this visualization I thought it would be most interesting to have categories for different types of crime. However, there are over 30 different categories generally, so in order to do this I sorted the different categories into even more general categories. Unfortunately, this has resulted in a large number of incidents being classified as 'other', but overall it seems to be reasonable. The exact categories which make up my six more general categories are shown below.</p>
      <div class="row">
        <div class="col-sm-2">
          <h3 align="left">Theft</h3>
          <ul align="left">
            <li>Larceny/theft</li>
            <li>Vehicle theft</li>
            <li>Robbery</li>
            <li>Forgery/counterfeiting</li>
            <li>Stolen property</li>
            <li>Embezzlement</li>
            <li>Bad checks</li>
            <li>Extortion</li>
            <li>Bribery</li>
            <li>Burglary</li>
            <li>Fraud</li>
          </ul>
        </div>
        <div class="col-sm-2">
          <h3 align="left">Controlled Substances/ Items</h3>
          <ul align="left">
            <li>Weapon laws</li>
            <li>Liquor laws</li>
            <li>Drug/narcotic</li>
            <li>Drunkenness</li>
            <li>Driving under the influence</li>
          </ul>
        </div>
        <div class="col-sm-2">
          <h3 align="left">Disorderly Conduct</h3>
          <ul align="left">
            <li>Vandalism</li>
            <li>Suspicious occ.</li>
            <li>Loitering</li>
            <li>Disorderly conduct</li>
            <li>Tresspass</li>
            <li>Gambling</li>
            <li>Prostitution</li>
          </ul>
        </div>
        <div class="col-sm-2">
          <h3 align="left">Violent Crime</h3>
          <ul align="left">
            <li>Arson</li>
            <li>Assault</li>
            <li>Suicide</li>
            <li>Sex offenses, forcible</li>
            <li>Sex offenses, non forcible</li>
          </ul>
        </div>
        <div class="col-sm-2">
          <h3 align="left">Kidnapping</h3>
          <ul align="left">
            <li>Runaway</li>
            <li>Kidnapping</li>
            <li>Missing person</li>
          </ul>
        </div>
        <div class="col-sm-2">
          <h3 align="left">Other</h3>
          <ul align="left">
            <li>Warrants</li>
            <li>Non-criminal</li>
            <li>Secondary codes</li>
            <li>Pornography/obscene mat.</li>
            <li>Family offenses</li>
            <li>Other offenses</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="container">
      <h2 align="left">Data-Preprocessing</h2>
      <p align="left">All data-preprocessing code can be found <a href="https://github.com/MichaelaHull/MichaelaHull.github.io/blob/master/data_files/project.R">here</a>.</p>
    </div>
  </div>

  <div class="section">
    <div class="container">
      <h2 align="left"><a name="discussion">Discussion</a></h2>
      <h3 align="left">Techniques</h3>
      <p align="left">For this project I used d3.js for all of my visualizations and for some of my data manipulation. However, most of my data manipulation was done in R. This was in part for my sanity and also so I could have more interactivity in my plots without it being painfully slow.</p>
      <p align="left"><strong>General</strong></p>
      <p align="left">For all of my visualizations I have encoded incident type by color so that they may be easily and quickly distinguished by the viewer. One of the main drawbacks of this is that there is a very large "other" category. I did my best to make this cateogry as small as possible, but it is already somewhat large in the raw data. I used ColorBrewer to pick colors which I found asthetically pleasing and so that the color intensities were reasonably similar.</p>
     
      <p align="left"><strong>Maps</strong></p>
      <p align="left">In order to display geographic information, I used topoJSON and a map of the San Francisco area as this is the most logical and reasonable way to show geographic information. Given that this is a very small part of the globe, there is less lie factor in terms of distances and sizes than there is when looking at a flattened globe. There is, however, the issue of overlapping points. To deal with this I decreased the opacity of the individual points so as to create a sense of depth. While this does help it does not entirely solve the problem, especially in the high-density areas of the map such as downtown. When looking at all of the points together, lots of points are obscured. Filtering by incident type does help with this, but does not entirely solve the problem. The lowered opacity also means that some points are more difficult to see. I did my best to find a balance between being able to see points and being able to have a good sense of density, but there are still some problems I cannot erase.</p>
      <p align="left">I also wanted more information to be available in the map, so I added a tooltip. In order to emphasize which point the viewer is actually looking at, I made the point enlarge and change opacity. Initially I tried keeping the color the same, however,  I found that in the high-density areas where the colors are already quite saturated, it was nearly impossible to see the point without some sort of color change. For this reason I also display the general category in the tooltip information since the visual color cue is no longer present when a point is selected.</p>
      <p align="left">I used button filtering with small multiple maps as the buttons to filter by different categories of incidents. This allows the viewer to have some idea of what the information they are filtering by will be so that they do not need to choose random cateogries in order to find information. I considered using similar buttons for filtering by neighborhood, but instead I used a drop-down filter. I chose this because there are ten neighborhoods and I did not think that there would be enough space on my visualization for ten more small maps and because the maps themselves would have so little information. Thus, a drop-down bar filter seemed much more reasonable.</p>
      <p align="left">Overall, I think my maps have pretty low lie factor, pretty high data density and a pretty good data-to-ink ratio. It shows very well the general layout of San Francisco and where clusters of incidents happen. As one might expect, there is an increase of activity for all incident types near downtown.</p>
      
      <p align="left"><strong>Bar Charts</strong></p>
      <p align="left">I used bar charts to show the overall rates of incidents both by type and by neighborhood. This is a simple way to compare things relatively, especially if they are ordered by size. For constancy, incident types are still encoded by color. Neighborhoods and resolutions are not, so the bars are colored in colors that I do not think links it to the other colors I have used.</p>
      <p align="left">I considered having the scales of the bar charts update as the charts update. However, I decided not to do this because I wanted to the viewer to be able to somewhat compare the rates between visualizations which becomes impossible if the scale is changing.</p>
      <p align="left">The bar charts are both my favorite part of this visualization and it's greatest weakness.</p>
      
      <p align="left"><strong>Time Series</strong></p>
      

      <h3 align="left">Interactivity</h3>
      <p align="left">The interactivity in these plots is fairly straightforward. In the large map I have a tooltip so that the viewer can see specific information for a single event, including the date, time of day, specific neighborhood and more details about exactly what happened. I also have the size, color, and opacity of the point change so that the viewer can see specifically which point they are looking at. Once the mouse is moved, the point returns to its original state and opacity.</p>
      <p align="left">I have also added two sorts of filtering. The first uses a drop-down bar and filters by neighborhood while the second uses the small multiples to the right of the larger map as filtering buttons and filters by incident type. As a visual cue to the viewer that these are buttons, the color of the button changes on a mouseover.</p>
      <p align="left">The frequency bars below the map update with the map. This means that they show only the information about the incidents which are visible on the map. This means that if the neighborhood Richmond is selected, the bars charts will only show incidents which occurred in Richmond. While this makes the neighborhood bar chart rather uninteresting, it is very interesting to see the frequency of incident type in that neighborhood.</p>
      <p align="left">The last part of interactivity is separate from the map and that is the time series. The time series allows for brushing so that the viewer may look at a specific part of the year.</p>
      

      <h3 align="left">Challenges</h3>
      <p align="left">One of the biggest challenges that I had with this project was the size of the dataset. It was initially large enough that I couldn't download it, so I subsetted out just a single year, which was still over 150,000 observations. This worked, but was slow, painfully slow when dealing with any sort of interactivity. In order to deal with that, made the data even smaller, subsetting it further to look only at a single month and doing the pre-processing for the time series in R. However, the more pre-processing that is done the harder it becomes to have interactivity between plots.</p>
      <p align="left">Filtering was rather difficult for me, though it became much easier once I realized that if I specifically classed and grouped the things I wanted to filter it was fairly simple to call them later. I also found it somewhat difficult to create smooth transitions. Some of this was certainly due to the way that things were being filtered initially though I think later the larger issue was the size of the data.</p>
      <p align="left">I am somewhat disappointed that I did not manage to create a spider plot. I had hoped to create two spider plots to show the fluctuation of incidents over time either aggregating by hour or aggregating by day of week. Because of the circular nature of days and weeks, I thought it would be fitting to put them as spider plots. While there is not much of a trend for day of week there is for time of day, mostly as you would expect but with a sudden spike around noon. Incidents in the "other" category also showed a distinct drop off after 5 pm, which makes sense when you consider that many of these types of incidents are people executing warrants, which is more likely to happen during business hours. It would have been simple to add time series or small multiple bar charts, but I did not think that these would make quite the same statement as a spider plot and the information would be lost in having too many plots of the same type, so I chose instead not to include them.</p>
      

      <h3 align="left">Conclusion</h3>
    </div>
  </div>


</body>
</head>
</html>